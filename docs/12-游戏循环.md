# ç¬¬ 12 è¯¾ï¼šæ¸¸æˆå¾ªç¯ ğŸ”„

æ¸¸æˆå¾ªç¯æ˜¯æ¸¸æˆçš„å¿ƒè„ï¼Œé©±åŠ¨æ•´ä¸ªæ¸¸æˆè¿è¡Œã€‚

---

## 12.1 ä»€ä¹ˆæ˜¯æ¸¸æˆå¾ªç¯ï¼Ÿ

æ¸¸æˆå¾ªç¯æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œä¸æ–­æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ¸¸æˆå¼€å§‹                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    1. å¤„ç†è¾“å…¥ (Input)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    2. æ›´æ–°é€»è¾‘ (Update)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    3. æ¸²æŸ“ç”»é¢ (Render)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
         ç»§ç»­å¾ªç¯ï¼Ÿ
        â•±         â•²
      æ˜¯           å¦
      â†“             â†“
   ç»§ç»­å¾ªç¯      é€€å‡ºæ¸¸æˆ
```

---

## 12.2 åŸºæœ¬æ¸¸æˆå¾ªç¯

```c
#include <stdbool.h>

int main(void) {
    bool running = true;
    
    // åˆå§‹åŒ–
    init_game();
    
    // æ¸¸æˆå¾ªç¯
    while (running) {
        // 1. å¤„ç†è¾“å…¥
        handle_input(&running);
        
        // 2. æ›´æ–°æ¸¸æˆçŠ¶æ€
        update_game();
        
        // 3. æ¸²æŸ“ç”»é¢
        render_game();
        
        // 4. æ§åˆ¶å¸§ç‡
        sleep_ms(16);  // çº¦ 60 FPS
    }
    
    // æ¸…ç†
    cleanup_game();
    return 0;
}
```

---

## 12.3 è´ªåƒè›‡çš„æ¸¸æˆå¾ªç¯

```c
void game_run(Game* game) {
    int last_update = 0;
    int current_time = 0;
    
    while (game->running) {
        // 1. å¤„ç†è¾“å…¥
        int key = input_get_key();
        if (key != ERR) {
            game_handle_input(game, key);
        }
        
        // 2. æ›´æ–°æ¸¸æˆï¼ˆæ ¹æ®éš¾åº¦æ§åˆ¶é€Ÿåº¦ï¼‰
        current_time++;
        int update_interval = game->speed;
        
        if (game->state == STATE_PLAYING && 
            current_time - last_update >= update_interval) {
            game_update(game);
            last_update = current_time;
        }
        
        // 3. æ¸²æŸ“
        game_render(game);
        
        // 4. çŸ­æš‚ä¼‘çœ ï¼Œé¿å… CPU å ç”¨è¿‡é«˜
        sleep_ms(10);
    }
}
```

---

## 12.4 è¾“å…¥å¤„ç†

```c
void handle_input(bool* running) {
    int key = getch();  // ncurses è·å–æŒ‰é”®
    
    if (key == 'q') {
        *running = false;
        return;
    }
    
    switch (key) {
        case KEY_UP:
        case 'w':
            snake_set_direction(DIR_UP);
            break;
        case KEY_DOWN:
        case 's':
            snake_set_direction(DIR_DOWN);
            break;
        case KEY_LEFT:
        case 'a':
            snake_set_direction(DIR_LEFT);
            break;
        case KEY_RIGHT:
        case 'd':
            snake_set_direction(DIR_RIGHT);
            break;
        case 'p':
            toggle_pause();
            break;
    }
}
```

---

## 12.5 æ›´æ–°é€»è¾‘

```c
void update_game(Game* game) {
    // 1. ç§»åŠ¨è›‡
    snake_move(game->snake);
    
    // 2. æ£€æŸ¥é£Ÿç‰©ç¢°æ’
    if (snake_eats_food(game->snake, game->food)) {
        score_add(&game->score, 10);
        snake_grow(game->snake);
        food_spawn(game->food);
    }
    
    // 3. æ£€æŸ¥æ­»äº¡ç¢°æ’
    if (snake_hit_wall(game->snake) || 
        snake_hit_self(game->snake)) {
        game->state = STATE_GAME_OVER;
    }
}
```

---

## 12.6 æ¸²æŸ“ç”»é¢

```c
void render_game(Game* game) {
    // æ¸…å±
    clear();
    
    // ç»˜åˆ¶è¾¹æ¡†
    draw_border();
    
    // ç»˜åˆ¶è›‡
    snake_render(game->snake);
    
    // ç»˜åˆ¶é£Ÿç‰©
    food_render(game->food);
    
    // ç»˜åˆ¶åˆ†æ•°
    draw_score(game->score);
    
    // åˆ·æ–°å±å¹•
    refresh();
}
```

---

## 12.7 æ§åˆ¶æ¸¸æˆé€Ÿåº¦

```c
// æ–¹æ³• 1ï¼šå›ºå®šå»¶è¿Ÿ
void sleep_ms(int ms) {
    struct timespec ts;
    ts.tv_sec = ms / 1000;
    ts.tv_nsec = (ms % 1000) * 1000000;
    nanosleep(&ts, NULL);
}

// æ–¹æ³• 2ï¼šåŸºäºæ—¶é—´æˆ³
#include <time.h>

double get_time(void) {
    struct timespec ts;
    clock_gettime(CLOCK_MONOTONIC, &ts);
    return ts.tv_sec + ts.tv_nsec / 1e9;
}

void game_loop(void) {
    double last_time = get_time();
    double target_fps = 60.0;
    double frame_time = 1.0 / target_fps;
    
    while (running) {
        double current = get_time();
        double delta = current - last_time;
        
        if (delta >= frame_time) {
            update_game();
            last_time = current;
        }
        
        render_game();
    }
}
```

---

## 12.8 å¸§ç‡ï¼ˆFPSï¼‰

```
FPS (Frames Per Second) = æ¯ç§’å¸§æ•°

60 FPS = æ¯å¸§ 16.67ms
30 FPS = æ¯å¸§ 33.33ms
10 FPS = æ¯å¸§ 100ms

è´ªåƒè›‡é€šå¸¸ 10-20 FPS å°±å¤Ÿäº†
```

```c
// è®¡ç®—å¹¶æ˜¾ç¤º FPS
int frame_count = 0;
double fps_timer = 0;
double fps = 0;

void update_fps(double delta) {
    frame_count++;
    fps_timer += delta;
    
    if (fps_timer >= 1.0) {
        fps = frame_count / fps_timer;
        frame_count = 0;
        fps_timer = 0;
    }
}

void render_fps(void) {
    printf("FPS: %.1f\n", fps);
}
```

---

## 12.9 å®Œæ•´ç¤ºä¾‹

```c
#include <stdio.h>
#include <ncurses.h>
#include <unistd.h>
#include <stdbool.h>

typedef struct {
    int x, y;
    int score;
    bool running;
} Game;

void init(Game* g) {
    initscr();
    cbreak();
    noecho();
    keypad(stdscr, TRUE);
    nodelay(stdscr, TRUE);
    
    g->x = 10;
    g->y = 10;
    g->score = 0;
    g->running = true;
}

void handle_input(Game* g) {
    int key = getch();
    switch (key) {
        case 'q': g->running = false; break;
        case KEY_UP: g->y--; break;
        case KEY_DOWN: g->y++; break;
        case KEY_LEFT: g->x--; break;
        case KEY_RIGHT: g->x++; break;
    }
}

void update(Game* g) {
    // æ¸¸æˆé€»è¾‘
}

void render(Game* g) {
    clear();
    mvprintw(g->y, g->x, "O");
    mvprintw(0, 0, "Score: %d | Press 'q' to quit", g->score);
    refresh();
}

void cleanup(void) {
    endwin();
}

int main(void) {
    Game game;
    init(&game);
    
    while (game.running) {
        handle_input(&game);
        update(&game);
        render(&game);
        usleep(100000);  // 100ms = 10 FPS
    }
    
    cleanup();
    return 0;
}
```

---

## âœ… æœ¬è¯¾æ£€æŸ¥æ¸…å•

- [ ] ç†è§£æ¸¸æˆå¾ªç¯çš„æ¦‚å¿µ
- [ ] æŒæ¡è¾“å…¥ - æ›´æ–° - æ¸²æŸ“æµç¨‹
- [ ] ä¼šæ§åˆ¶æ¸¸æˆé€Ÿåº¦
- [ ] ç†è§£ FPS çš„æ¦‚å¿µ
- [ ] èƒ½å®ç°åŸºæœ¬çš„æ¸¸æˆå¾ªç¯

---

## ğŸ“ ä½œä¸š

1. å®ç°ä¸€ä¸ªç®€å•çš„å°çƒå¼¹è·³åŠ¨ç”»ï¼ˆä½¿ç”¨æ¸¸æˆå¾ªç¯ï¼‰

2. ä¸ºè´ªåƒè›‡æ·»åŠ æš‚åœåŠŸèƒ½ï¼ˆæŒ‰ P é”®ï¼‰

3. æ·»åŠ  FPS æ˜¾ç¤º

---

ä¸‹ä¸€è¯¾ï¼š[ncurses åº“](13-ncurses åº“.md)

---

## é™„å½•ï¼šçŠ¶æ€æœºç®€ä»‹

æ¸¸æˆé€šå¸¸æœ‰å¤šç§çŠ¶æ€ï¼ˆå¼€å§‹èœå•ã€æ¸¸æˆä¸­ã€æ¸¸æˆç»“æŸï¼‰ï¼š

```c
typedef enum {
    STATE_MENU,
    STATE_PLAYING,
    STATE_PAUSED,
    STATE_GAME_OVER
} GameState;

void game_loop(Game* game) {
    while (game->running) {
        handle_input(game);
        
        switch (game->state) {
            case STATE_MENU:
                update_menu(game);
                render_menu(game);
                break;
            case STATE_PLAYING:
                update_game(game);
                render_game(game);
                break;
            case STATE_PAUSED:
                render_pause_screen(game);
                break;
            case STATE_GAME_OVER:
                render_game_over(game);
                break;
        }
        
        usleep(100000);
    }
}
```

è¯¦ç»†è®²è§£è§ [ç¬¬ 14 è¯¾ï¼šçŠ¶æ€æœº](14-çŠ¶æ€æœº.md)
